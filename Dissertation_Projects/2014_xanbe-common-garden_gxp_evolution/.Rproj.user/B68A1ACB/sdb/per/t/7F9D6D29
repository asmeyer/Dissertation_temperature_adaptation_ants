{
    "contents" : "---\ntitle: \"Evolution of thermal limits and stress response in Aphaenogaster\"\nauthor: \"Andrew Nguyen\"\ndate: \"2015-August-28\"\noutput: pdf_document\n---\n#Overview\n##Question: What forces shapes heat tolerance in Aphanogaster? \n\n##Hypothesis: Common ancestry and/or ecology shape heat tolerance\n\n###Methods: Ants were collected in 2014 and acclimated in a common garden experiment\n\n```{r libraries, echo=FALSE,include=FALSE}\nlibrary(lattice)\nlibrary(permute)\nlibrary(vegan)\nlibrary(MASS)\nlibrary(sp)\nlibrary(rgdal) \nlibrary(dismo)\nlibrary(maptools)\nlibrary(foreign)\nlibrary(grid)\nlibrary(lattice)\nlibrary(maps)\nlibrary(ape)\n#library(leaps)\nlibrary(QuantPsyc)\nlibrary(ggplot2)\nlibrary(MuMIn)\nlibrary(plyr)\nlibrary(dplyr)\nlibrary(mvSLOUCH)\noptions(na.action = \"na.fail\")\nlibrary(phytools)\nlibrary(picante)\nlibrary(raster)\nlibrary(VennDiagram)\n```\n\n#data parsing\n1) distance matrix from RaxML, solutioN:\nhttp://stackoverflow.com/questions/22492767/converting-pairwise-distances-into-a-distance-matrix-in-r\n```{r rAXML}\njj<-read.csv(\"Phylogenetics//RAxML_distances.20150828_commongarden_pairwise_ML_distance.csv\",header=F)\nstr(jj)\n#as.dist(xtabs(jj[,3]~jj[,2]+jj[,1]))\ndfr<-reshape(jj,direction=\"wide\",idvar=\"V2\",timevar=\"V1\")\ndfr\npcoa(dfr)\nwrite.csv(dfr,\"dfr.csv\")\nwrite.csv(t(dfr),\"dfr_transposed.csv\")\n```\n\n2) rreading in data and such\n```{r data parsing}\ndat<-read.csv(\"2014_sampling_data_sheet.csv\")#sampling data\ntree<-read.tree(\"Phylogenetics/20150828_raxml_commongarden_NO_BS.nex\")#phylogeny with branch lengths only\n#removing a few tips for plotting purposes\ntree1<-drop.tip(tree,tip=c(\"PB17-14\",\"PB17-10\",\"PB07-23\",\"PMBE\",\"ALA5\",\"LVA2\"))\ntree2<-root(tree1,node=105,resolve.root=TRUE)\nplot(tree2)\n##kk, I really want a distance matrix for the ingroup, so I need to get rid of pogos\nfinal.tree<-drop.tip(tree,tip=c(\"EXIT65\",\"SAL13-14\",\"PMBE\",\"ALA5\",\"LVA2\",\"PB17-14\",\"PB17-10\",\"PB07-23\"))\nplot(final.tree)\n##kk, do pcoa and add to original dataset\ndist.mat<-cophenetic.phylo(final.tree)\nknitr::kable(head(dist.mat[1:4,1:6]))\naph.pcoa<-pcoa(dist.mat)\nknitr::kable(aph.pcoa$values)#eigenvalues\n#axis 1 = 44%\n#axis2 = 23 %\n#first 10 PCs add up to 76% of variation\naph.pcoa$values[1,1]/sum(aph.pcoa$values[,1])# double checking\n\nbiplot(aph.pcoa)#biplot of first 2 axes\n#plot(aph.pcoa$vectors[,3],aph.pcoa$vectors[,4])\n#write.csv(aph.pcoa$values[,1:2],\"aph_pcoa_1_2.csv\")\n#extracting the new scores/Axis values\n#and assigning the right names\nsub.pcoa<-as.data.frame(aph.pcoa$vectors);sub.pcoa$Sample<-final.tree$tip.label\n##another thing you should try is to\n##analyze the raxml ML estimate of pairwise distances\nplot(sub.pcoa[,1],sub.pcoa[,2],type='n')\ntext(sub.pcoa[,1],sub.pcoa[,2],labels=sub.pcoa$Sample)\n\n\n#rudis, miamiana, lamellidens clade\nplot(sub.pcoa[,1],sub.pcoa[,2],type='n',ylim=c(.01,.1),xlim=c(0,.05))\ntext(sub.pcoa[,1],sub.pcoa[,2],labels=sub.pcoa$Sample)\n\n##visiualizing diff clade\n#tenn and fulva\nplot(sub.pcoa[,1],sub.pcoa[,2],type='n',ylim=c(-.1,0),xlim=c(-.25,-.2))\ntext(sub.pcoa[,1],sub.pcoa[,2],labels=sub.pcoa$Sample)\n\n#visualizing axis 3\nplot(sub.pcoa[,1],sub.pcoa[,3],type='n')\ntext(sub.pcoa[,1],sub.pcoa[,3],labels=sub.pcoa$Sample)\n##merging Axes with original datset\n#lets check the dimensions of the dataframe\ndim(sub.pcoa)\ndim(dat)\nmerg<-inner_join(dat,sub.pcoa,by=\"Sample\")\ndim(merg) #79 TAXA\n\n##we actually need climate data from woldclim\nw<-getData('worldclim',var='bio',res=2.5)\nmergy<-as.data.frame(cbind(merg,dbio1))\n\n#gonna pca climate data bio1-bio7 (temp related) and bio12-bio15(precip related)\nclim<-princomp(scale(cbind(mergy[,99:105],mergy[,110:113])))\nsummary(clim)# first 2 pcs epxlain 90% of variation\n#pc1 - 73% of variation\n#pc2 - 18% of variation\n#pc3 - 5%\n#pc4 - 2.19%\nknitr::kable(clim$loadings[,1:4])\nwrite.csv(clim$loadings[,1:2],\"20150903_anbe_common_garden.csv\")\nmergy2<-as.data.frame(cbind(mergy,clim$scores[,1:4]))\n```\n\nStats:\n```{r set of regressions}\n#evaluating tmax with phylo axes\n#Tmax\nfull<-lm(KO_temp_worker~bio5*Axis.1+bio5*Axis.2+bio5*Axis.3+bio5*Axis.4+bio5*Axis.5+bio5*Axis.6+bio5*Axis.7,data=mergy2)\nmod3<-stepAIC(full,direction=\"forward\")\nsummary(mod3)\nsummary(stepAIC(full,direction=\"backward\"))\n#with pca instead of bio5\nfull.p<-lm(KO_temp_worker~Comp.1*Axis.1+Comp.1*Axis.2+Comp.1*Axis.3+Comp.1*Axis.4+Comp.1*Axis.5,data=mergy2)\nmod2<-stepAIC(full.p,direction=\"forward\")\nsummary(mod2)\nsummary(stepAIC(full.p,direction=\"backward\"))\n#plotting axis 1 and 2\nplot(aph.pcoa$vectors[,1],aph.pcoa$vectors[,2],col=match$color,pch=16,xlim=c(-.3,.2),ylim=c(-.15,.12),xlab=\"Axis 1\",ylab=\"Axis 2\")\n```\n#Paritioning variation into independent phylo, independent climate, and shared phylo and cliamte components\n```{r Partitioning variation}\n#determining the number of phylo axes components\nphylo.axis.mod<-lm(KO_temp_worker~Axis.1+Axis.2+Axis.3+Axis.4+Axis.5+Axis.6+Axis.7+Axis.8+Axis.9+Axis.10+Axis.11+Axis.12+Axis.13+Axis.14+Axis.15,data=mergy2)\nhist(phylo.axis.mod$residuals)\nsummary(stepAIC(phylo.axis.mod,direction=\"forward\"))\nsummary(stepAIC(phylo.axis.mod,direction=\"backward\"))\n\n##determining the number of climate axes components\nclim.axis.mod<-lm(KO_temp_worker~Comp.1+Comp.2+Comp.3+Comp.4,data=mergy2)\nsummary(stepAIC(clim.axis.mod,direction=\"forward\"))\nsummary(stepAIC(clim.axis.mod,direction=\"backward\"))\n\n#using varpart on backwards selection of Axes for phylo\n#and backwards selection of axes for clim\nbacksel.mod<-varpart(mergy2$KO_temp_worker,~Axis.1+Axis.2+Axis.3+Axis.6+Axis.7,~Comp.1+Comp.3+habitat,data=mergy2)\nbacksel.mod\nplot(backsel.mod)\n\n\n#Using varpart to partition variation with first phylo axes\n\nnc.2<-varpart(mergy2$KO_temp_worker,~Axis.1+Axis.2+Axis.3+Axis.4+Axis.5+Axis.6,~Comp.1+Comp.2+habitat,data=mergy2)\nnc.2\nplot(nc.2)\n\n#test<-varpart(mergy2$KO_temp_worker,~Axis.1,~Comp.1+Comp.2+habitat,data=mergy2)\n#test\n#plot(test)\n#rda's\n\n#all, a + b + c\nall<-rda(mergy2$KO_temp_worker~Axis.1+Axis.2+Axis.3+Axis.4+Axis.5+Axis.6+Comp.1+Comp.2+habitat,data=mergy2)\nanova(all)\n# fraction a\n#rda.phylo<-rda(mergy2$KO_temp_worker~Condition(Axis.1+Axis.2+Axis.3+Axis.4+Axis.5+Axis.6)+Comp.1+Comp.2+habitat,data=mergy2)\nrda.phylo<-rda(mergy2$KO_temp_worker~Condition(Axis.1)+Comp.1+Comp.2+habitat,data=mergy2)\nanova(rda.phylo)\n#fraction c\nrda.clim<-rda(mergy2$KO_temp_worker~Axis.1+Axis.2+Axis.3+Axis.4+Axis.5+Axis.6+Condition(Comp.1+Comp.2+habitat),data=mergy2)\nanova(rda.clim)\n#fraction a+b\nrda.frac.phylo<-rda(mergy2$KO_temp_worker~Axis.1+Axis.2+Axis.3+Axis.4+Axis.5+Axis.6,data=mergy2)\nanova(rda.frac.phylo)\n#fraction b + c\nrda.frac.clim<-rda(mergy2$KO_temp_worker~Comp.1+Comp.2+habitat,data=mergy2)\nanova(rda.frac.clim)\n\n\n#a<-nc.2$part$fract[,3]\na<-nc.2$part$indfract[1:3,3]*100\n#library(venneuler)\n#v<-venneuler(c(A=a[1]+a[2],B=a[3]+a[2],\"A&B\"=a[2]))\n#plot(v)\ngrid.newpage()\ndraw.pairwise.venn(area1=a[1]+a[2],area2=a[2]+a[3],cross.area=a[2],lty=rep(\"blank\",2),fill=c(\"blue\",\"red\"),alpha=(rep(.4,2)),cat.dist=rep(0.025,2),cat.pos=c(0,0),ext.text=F,cex=0)\n\n\n```\n\n#plotting data against the phylogeny\n```{r barplot next to tree}\ntrans<-read.tree(\"Phylogenetics/20150831_transformed_bl_raxml.newick\")\nplot.tree1<-drop.tip(trans,tip=c(\"LVA2\",\"PMBE\",\"PB17-14\",\"PB17-10\",\"PB07-23\"))\n#plot.tree2<-rotate(plot.tree1,node=84)\nplot(plot.tree2)\n\n#matching species with thermal trait data-pain in the ass\nid<-as.data.frame(plot.tree2$tip.label)\nnames(id)<-\"Sample\"\nmatch<-inner_join(id,dat,by=\"Sample\")\nmatch$color<-ifelse(match$habitat==\"flat woods\",\"red\",\"lightblue\")\nmatch[82:83,]$color<-c(\"orange\",\"orange\") # color for messor\ndim(match)\nx<-as.vector(match$KO_temp_worker)\nnames(x)<-match$Sample\nx<-x[match(plot.tree2$tip.label,names(x))]\n#xx<-match.phylo.data(plot.tree2, x)\n## create a split plot\nlayout(matrix(c(1,2),1,2),c(0.7,0.3))\n## plot our tree\nplot(plot.tree1,edge.width=3,cex=.5)\n## add bar plot\npar(mar=c(4.1,0,1.1,1.1))\nbarplot(x[plot.tree1$tip.label],horiz=TRUE,width=1,space=0,\n  ylim=c(1,length(plot.tree1$tip.label))-0.5,names=\"\",xlim=c(38,43),col=match$color)\n#barplot(x[tree$tip.label],horiz=TRUE,width=1,space=0,\n  #ylim=c(1,length(tree$tip.label))-0.5,names=\"\")\n```\n\n#PGLS\n```{r PGLS}\nlibrary(caper)\nnew.dat<-inner_join(mergy2,match,by=\"Sample\")\n#traits$KO<-as.numeric(as.character(traits$KO))\ncdobj<-comparative.data(plot.tree2, new.dat,Sample)\npgls_mod<-pgls(KO_temp_worker.x~ Comp.1+Comp.2+Comp.3, data=cdobj, lambda=\"ML\")\nsummary(pgls_mod)\nplot(pgls.profile(pgls_mod))\npgls.profile(pgls_mod)$ci$opt\n```\n###no sig effect\n\n\n#PHylogenetic anova\n```{r}\n#phylo anova\n#removing outgroup and ma\nnew.tree<-drop.tip(plot.tree1,tip=c(\"ALA5\",\"EXIT65\",\"SAL13-14\")) #taking out ma and outgroups\nnew.data2<-new.dat[match(new.tree$tip.label,new.dat$Sample),] #making sure sample order\n\n\nnew.data<-droplevels(new.data2)\n#regular anova\nreg<-aov(KO_temp_worker.x~habitat.x,data=new.data)\nsummary(reg)\n\n#phylogenetic anova\nh<-phylANOVA(new.tree,new.data$habitat.x,new.data$KO_temp_worker.x,p.adj=\"hochberg\")\nh\n#phylosig\n#bloomberg's K\nphylosig(new.tree,new.data$KO_temp_worker.x,method=\"K\")\n#lambda\nphylosig(new.tree,new.data$KO_temp_worker.x,method=\"lambda\")\n\n```\n\n\n```{r sessioninfo}\nsessionInfo()\n```\n\n",
    "created" : 1443535792020.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "200|27|227|3|\n230|11|239|3|\n",
    "hash" : "4112825711",
    "id" : "7F9D6D29",
    "lastKnownWriteTime" : 1442599494,
    "path" : "~/zscience/Dimensions_project/Data/2015_xanbe-common-garden_gxp_evolution/20150828_evo_heat_tolerance_aphaenogaster_v2.Rmd",
    "project_path" : "20150828_evo_heat_tolerance_aphaenogaster_v2.Rmd",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_markdown"
}