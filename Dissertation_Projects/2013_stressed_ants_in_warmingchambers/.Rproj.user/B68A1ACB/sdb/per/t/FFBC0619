{
    "contents" : "---\ntitle: \"Will climate change cause temperature stress?\"\nauthor: \"Andrew Nguyen\"\ndate: \"2015-August-24\"\noutput: pdf_document\n---\n#Rationale\n\n#Experimental protocol\n\n#Samples\n\n```{r loading libraries}\nlibrary(plyr)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(tidyr)\nlibrary(MASS)\n```\n#Calculating gene expression   \nGOI= gene of interest  \nHKG= house keeping gene   \n\n$\\frac{2^{(GOI_{mean}-GOI_{sample})}}{2^{(HKG_{mean}-HKG_{sample})}}$\n\n```{r calculating gxp}\n#warm<-read.csv(\"2015_warming_prelim.csv\") #reading in the data set\nwarm<-read.csv(\"20160211_DF_Aph_Cham_LNSampling.csv\")\nhead(warm,4) #big data, so only looking at first 4 lines\ntail(warm,4) # looking at the last 4 lines\nnames(warm) #looking at the names of the headings in data set\ndim(warm) # looking at the dimensions...rows,columns\n\n#calculating the mean bait_temp\nwarm$mean.temps<-rowMeans(warm[,8:11],na.rm=T)\n\n\n\ngene.means<-apply(na.omit(warm[,14:17]),2,mean) #taking the means of each gene\ngene.means\n\ndeltaCT<-as.data.frame(t(apply(warm[,14:17],1,function(x){gene.means-x}))) # subtracting the means of each gene with each sample\n\ndd<-as.data.frame(t(apply(deltaCT,1,function(x){2^x})))# raising everything to 2 power\nnames(dd)<-c('18s',\"hsp40\",\"hsp70\",\"hsp83\")\n#Calculating fold change!\nmerg<-as.data.frame(cbind(warm,dd[,2:4]/dd[,1]))\n\n\n```\n\n#Stats!!\n##response:\n##predictor\n```{r stats}\n#changing collection date into a facto\n#merg$Collection.Date<-as.factor(as.character(merg$Collection.Date))\n\n#making plots\nmerg$color<-ifelse(merg$Site==\"DF\",\"red\",\"blue\")# making color\nmerg2<-subset(merg,merg$hsp83<100)\n#Doing stats\n#new<-na.exclude(merg2)\n#new1<-subset(merg2,merg2$hsp83 != \"NA\")\nnew<-subset(merg2,merg2$hsp70 != \"NA\")\nnew2<-subset(merg2,merg2$hsp40 != \"NA\");new2<-new2[-37,]\n\nmod1<-stepAIC(lm(log10(hsp70)~Site*mean.temps+RIN_Value,data=new),direction=\"backward\")\nsummary(mod1)\n\nmod1.1<-lm(log10(hsp70)~Site*mean.temps+RIN_Value,data=new)\nsummary(mod1.1)\n\n#model for hsp40\nmod2<-stepAIC(lm(log10(hsp40)~Site*mean.temps+RIN_Value,data=new2),direction=\"backward\");summary(mod2)\n\nmod2.1<-lm(log10(hsp40)~Site*mean.temps+RIN_Value,data=new2)\nsummary(mod2.1)\n\n\n#hsp83\nmod3<-stepAIC(lm(log10(hsp83)~Site*mean.temps+RIN_Value,data=merg2),direction=\"backward\");summary(mod3)\nboxplot(log10(hsp83)~Site,data=merg2)\nmod3.1<-lm(log10(hsp83)~Site*mean.temps+RIN_Value,data=merg2)\nsummary(mod3.1)\n\n\n\npar(mfrow=c(2,2))\nplot(mod3)\npar(mfrow=c(1,1))\n#hsp83 plot\nplot(merg2$mean.temps,log10(merg2$hsp83),col=merg2$color,pch=16,ylab=\"Log10 Hsp83 relative expression\",xlab=\"Local Temperature(°C)\",las=1,ylim=c(-3,3))\naxis(1,lwd=2);box(lwd=2);axis(2,lwd=2,las=1)\n#text(merg2$mean.temps,log10(merg2$hsp83),labels=merg2$Vial.Name)\nabline(lm(log10(hsp83)~mean.temps,data=subset(merg2,merg2$Site==\"DF\")),lty=\"dotdash\",col=\"red\",lwd=3)\nabline(lm(log10(hsp83)~mean.temps,data=subset(merg2,merg2$Site==\"HF\")),lty=\"dotdash\",col=\"blue\",lwd=3)\n\n\n#hsp70 plot\nplot(new$mean.temps,log10(new$hsp70),col=new$color,pch=16,ylab=\"Log10 Hsp70 relative expression\",xlab=\"Local Temperature (°C)\",las=1,ylim=c(-3,3))\naxis(1,lwd=2);box(lwd=2);axis(2,lwd=2,las=1)\n#text(merg2$mean.temps,log10(merg2$hsp83),labels=merg2$Vial.Name)\nabline(lm(log10(hsp70)~mean.temps,data=subset(new,new$Site==\"DF\")),lty=\"dotdash\",col=\"red\",lwd=3)\nabline(lm(log10(hsp70)~mean.temps,data=subset(new,new$Site==\"HF\")),lty=\"dotdash\",col=\"blue\",lwd=3)\n\n\n#hsp40\nplot(new2$mean.temps,log10(new2$hsp40),col=merg2$color,pch=16,ylab=\"Log10 Hsp40 relative expression\",xlab=\"Local Temperature (°C)\",las=1,ylim=c(-2,2))\naxis(1,lwd=2);box(lwd=2);axis(2,lwd=2,las=1)\n#text(merg2$mean.temps,log10(merg2$hsp83),labels=merg2$Vial.Name)\nabline(lm(log10(hsp40)~mean.temps,data=subset(new2,new2$Site==\"DF\")),lty=\"dotdash\",col=\"red\",lwd=3)\nabline(lm(log10(hsp40)~mean.temps,data=subset(new2,new2$Site==\"HF\")),lty=\"dotdash\",col=\"blue\",lwd=3)\n\nsummary(aov(mean.temps~Site,data=subset(merg2,merg2$Year==\"2013\")))\nggplot(merg2,aes(y=mean.temps,x=Site))+geom_boxplot()\n```\n\n```{r 1000/ct method}\n#using merg 2, convertin xp to 100/ct\nnames(merg2)\n\n\ndiff.way<-as.data.frame(cbind(merg2[,1:7],apply(merg2[,14:17],2,function(x){1000/x}),merg2[,19]))\nnames(diff.way)[12]<-\"mean.temps\"\nsd(diff.way$CT_18s)/mean(diff.way$CT_18s)\n\n#summary(lm(CT_83~Site*mean.temps+CT_18s+Year,data=diff.way))\n#plot(diff.way$mean.temps,diff.way$CT_83)\n#summary(lm(CT_70~Site*mean.temps+CT_18s+Year,data=diff.way))\n#summary(lm(CT_40~Site*mean.temps+CT_18s+Year,data=diff.way))\n\n#stepwise\nlibrary(MASS)\nmod11<-stepAIC(lm(CT_83~Site*mean.temps+CT_18s+Year,data=diff.way),direction=\"backward\")\nsummary(mod11)\n#plot(mod11)\n\nsummary(stepAIC(lm(CT_70~Site*mean.temps+CT_18s+Year,data=diff.way),direction=\"backward\"))\n\nsummary(stepAIC(lm(CT_40~Site*mean.temps+CT_18s+Year,data=diff.way),direction=\"backward\"))\n\n#18s rRNA\nsummary(stepAIC(lm(CT_18s~Site*mean.temps+Year,data=diff.way),direction=\"backward\"))\n\n#only analyzing 2013\ndiff.way2<-subset(diff.way,diff.way$Year==\"2013\")\n\n#summary(lm(CT_83~Site*mean.temps+CT_18s,data=diff.way2))\n#summary(lm(CT_70~Site*mean.temps+CT_18s,data=diff.way2))\n#summary(lm(CT_40~Site*mean.temps+CT_18s,data=diff.way2))\n\n#stepwise\nmod22<-stepAIC(lm(CT_83~Site*mean.temps+CT_18s,data=diff.way2),direction=\"backward\");summary(mod22)\n\nmod23<-stepAIC(lm(CT_70~Site*mean.temps+CT_18s,data=diff.way2),direction=\"backward\");summary(mod23)\n\nmod24<-stepAIC(lm(CT_40~Site*mean.temps+CT_18s,data=diff.way2),direction=\"backward\");summary(mod24)\n\n\n```\n\n```{r ggplots}\n#adjusting sizing\nsizzy<- theme_bw()+\n  theme(axis.title.y=element_text(size=rel(2)),axis.title.x=element_text(size=rel(3)))+\n  theme(axis.text.y=element_text(size=rel(2)),axis.text.x=element_text(size=rel(2)),legend.position=c(.85,.89))+\n  theme(legend.title=element_blank(),legend.text=element_text(size=28),panel.grid.major=element_blank())\n\ndiff.way$Year<-as.factor(as.character(diff.way$Year))\n\n#18s rRNA\ndiff.way2$col<-ifelse(diff.way2$Site==\"DF\",\"red\",\"blue\")\nplot(diff.way2$mean.temps,diff.way2$CT_18s,col=diff.way2$col,pch=16,ylab=\"18s rRNA gene expression (1000/CT)\",xlab=\"Local Temperature\",ylim=c(0,200))\nabline(lm(CT_18s~mean.temps,data=subset(diff.way2,diff.way2$Site==\"DF\")),lwd=5,lty=2,col=\"red\")\nabline(lm(CT_18s~mean.temps,data=subset(diff.way2,diff.way2$Site==\"HF\")),lwd=5,lty=6,col=\"blue\")\npoints(diff.way2$mean.temps,diff.way2$CT_83,col=diff.way2$col,pch=17)\n#text(diff.way2$mean.temps,diff.way2$CT_18s,labels=diff.way2$Vial.Name)\n\n\n#hsp83 fig\nggplot(diff.way2,aes(x=mean.temps,y=CT_83,colour=Site,shape=Site))+geom_point(size=3)+scale_x_continuous(\"Local Temperature\",breaks=seq(0, 100,2),limits=c(21,34))+scale_y_continuous(\"Hsp83 expression (1000/CT)\",breaks=seq(0, 100,5),limits=c(28,52))+geom_smooth(method=lm,se=FALSE,size=3)+sizzy\n\n\nggplot(diff.way,aes(x=mean.temps,y=CT_70,colour=Site))+geom_point(size=3)+scale_x_continuous(\"Local Temperature\",limits=c(21,34))+scale_y_continuous(\"Hsp70 expression (1000/CT)\",limits=c(28,52))+geom_smooth(method=lm,se=FALSE,size=3)\n\n#hsp40\nggplot(diff.way2,aes(x=mean.temps,y=CT_40,colour=Site))+geom_point(size=3)+scale_x_continuous(\"Local Temperature\",limits=c(21,34))+scale_y_continuous(\"Hsp40 expression (1000/CT)\",limits=c(25,42))+geom_smooth(method=lm,se=F,size=3)\n\n```\n\n```{r ggplot with no site effect, eval=FALSE,include=FALSE}\n#Hsp83\nggplot(diff.way,aes(x=mean.temps,y=CT_83))+geom_point(size=3)+scale_x_continuous(\"Local Temperature (°C)\",limits=c(22,34),breaks=seq(0,50,2))+scale_y_continuous(\"Hsp83 expression (1000/CT)\",limits=c(25,55),breaks=seq(0,55,5))+geom_smooth(method=lm,se=F,size=3)+sizzy\n\n#hsp70\nggplot(diff.way,aes(x=mean.temps,y=CT_70))+geom_point(size=3)+scale_x_continuous(\"Local Temperature (°C)\",limits=c(22,34),breaks=seq(0,50,2))+scale_y_continuous(\"Hsp70 expression (1000/CT)\",limits=c(25,55),breaks=seq(0,55,5))+geom_smooth(method=lm,se=F,size=3)+sizzy\n\n#hsp40 no site effect\nggplot(diff.way,aes(x=mean.temps,y=CT_40))+geom_point(size=3)+scale_x_continuous(\"Local Temperature (°C)\",limits=c(22,34),breaks=seq(0,50,2))+scale_y_continuous(\"Hsp40 expression (1000/CT)\",limits=c(25,42))+geom_smooth(method=lm,se=F,size=3)+sizzy\n\n#plotting all of the points\nnames(diff.way)\ndiff<-gather(diff.way,gene,expression,CT_18s:CT_40:CT_70:CT_83)\ndim(diff)\ndiffy<-na.omit(diff)\ndiffy<-droplevels(subset(diffy,diffy$gene !=\"CT_18s\"))\ndim(diffy)\nggplot(diffy,aes(x=mean.temps,y=expression,shape=gene,colour=gene))+\n  geom_point(size=3,stat=\"identity\")+\n  scale_x_continuous(\"Local Temperature (°C)\",limits=c(22,34),breaks=seq(0,50,2))+scale_y_continuous(\"Stress Response (Hsp gene expression, 1000/CT)\",limits=c(25,55),breaks=seq(0,55,5))+geom_smooth(method=lm,se=F,size=3,aes(fill=gene))+sizzy+scale_colour_manual(values=c(\"red\",\"blue\",\"purple\"))\n  \n  \n#  scale_shape_discrete(name=\"Gene\",breaks=c(\"CT_40\" ,\"CT_70\",  \"CT_83\"),labels=c(\"Hsp83\",\"Hsp70\",\"Hsp40\"))+scale_colour_manual(values=c(\"red\",\"blue\",\"purple\"))\n\n```\n\n```{r Normfinder function}\nNormfinder=function(filename,Groups=TRUE,ctVal=TRUE,pStabLim=0.25){\n#\n# If Groups is TRUE the last row contains the group identifier,\n# and the last row must be started by a name for that row.\n# No spaces are allowed in the gene names, sample names and group identifier.\n#\ndat0=read.table(filename,header=TRUE,row.names=1,colClasses=\"character\")\n#\nntotal=dim(dat0)[2] # number of samples\nk0=dim(dat0)[1] # number of rows\n#\nif (Groups){\n ngenes=k0-1 # number of genes\n genenames=rownames(dat0)[-k0]\n grId=dat0[k0,]\n dat0=dat0[-k0,]\n } else {\n ngenes=k0 # number of genes\n genenames=rownames(dat0)\n grId=rep(1,ntotal)\n }\n#\ndat=matrix(as.numeric(unlist(dat0)),ngenes,ntotal) # matrix instead of list\n#\nif (!ctVal){dat=log2(dat)} # transform to log2 values\n#\nsamplenames=colnames(dat0)\ngrId=factor(unlist(grId))  # group identifier\ngroupnames=levels(grId)  # group names\nngr=length(levels(grId)) # number of groups\n# Number of samples in each group:\nnsamples=rep(0,ngr)\nfor (group in 1:ngr){nsamples[group]=sum(grId==groupnames[group])}\n#\n#\nMakeStab=function(da){\nngenes=dim(da)[1]\n# Sample averages\nsampleavg=apply(da,2,mean)\n# Gene averages within group\ngenegroupavg=matrix(0,ngenes,ngr)\nfor (group in 1:ngr){\n  genegroupavg[,group]=apply(da[,grId==groupnames[group]],1,mean)}\n# Group averages\ngroupavg=rep(0,ngr)\nfor (group in 1:ngr){groupavg[group]=mean(da[,grId==groupnames[group]])}\n\n# Variances \nGGvar=matrix(0,ngenes,ngr)\nfor (group in 1:ngr){\n grset=(grId==groupnames[group])\n a=rep(0,ngenes)\n for (gene in 1:ngenes){\n  a[gene]=sum((da[gene,grset]-genegroupavg[gene,group]-\n          sampleavg[grset]+groupavg[group])^2)/(nsamples[group]-1)\n  }\n GGvar[,group]=(a-sum(a)/(ngenes*ngenes-ngenes))/(1-2/ngenes)\n }\n#\n# Change possible negative values\ngenegroupMinvar=matrix(0,ngenes,ngr)\nfor (group in 1:ngr){\n grset=(grId==groupnames[group])\n z=da[,grset]\n for (gene in 1:ngenes){\n  varpair=rep(0,ngenes)\n  for (gene1 in 1:ngenes){varpair[gene1]=var(z[gene,]-z[gene1,])}\n  genegroupMinvar[gene,group]=min(varpair[-gene])/4\n  }\n }\n#\n# Final variances\nGGvar=ifelse(GGvar<0,genegroupMinvar,GGvar)\n#\n# Old stability measure for each gene is calculated:\n#\ndif=genegroupavg\ndifgeneavg=apply(dif,1,mean)\ndifgroupavg=apply(dif,2,mean)\ndifavg=mean(dif)\nfor (gene in 1:ngenes){\n for (group in 1:ngr){\n  dif[gene,group]=dif[gene,group]-difgeneavg[gene]-difgroupavg[group]+difavg\n  }\n }\n#\nnsampMatrix=matrix(rep(nsamples,ngenes),ngenes,ngr,byrow=T)\nvardif=GGvar/nsampMatrix\ngamma=sum(dif*dif)/((ngr-1)*(ngenes-1))-sum(vardif)/(ngenes*ngr)\ngamma=ifelse(gamma<0,0,gamma)\n#\ndifnew=dif*gamma/(gamma+vardif)\nvarnew=vardif+gamma*vardif/(gamma+vardif)\nOstab0=abs(difnew)+sqrt(varnew)\nOstab=apply(Ostab0,1,mean)\n#\n# Measure of group differences:\nmud=rep(0,ngenes)\nfor (gene in 1:ngenes){\n mud[gene]=2*max(abs(dif[gene,]))\n }\n# Common variance:\ngenevar=rep(0,ngenes)\nfor (gene in 1:ngenes){\n genevar[gene]=sum((nsamples-1)*GGvar[gene,])/(sum(nsamples)-ngr)\n }\nGsd=sqrt(genevar)\n#\n# Return results:\n#\nreturn(cbind(mud,Gsd,Ostab,rep(gamma,ngenes),GGvar,dif))\n}    # End of function MakeStab\n#\n#\nMakeComb2=function(g1,g2,res){\ngam=res[1,4]\nd1=res[g1,(4+ngr+1):(4+ngr+ngr)]; d2=res[g2,(4+ngr+1):(4+ngr+ngr)]\ns1=res[g1,(4+1):(4+ngr)]^2; s2=res[g2,(4+1):(4+ngr)]\nrho=abs(gam*d1/(gam+s1/nsamples)+gam*d2/(gam+s2/nsamples))*\n sqrt(ngenes/(ngenes-2))/2\nrho=rho+sqrt(s1/nsamples+gam*s1/(nsamples*gam+s1)+\n s2/nsamples+gam*s2/(nsamples*gam+s2))/2\nreturn(sum(rho)/2)\n}\n#\n#\nMakeStabOne=function(da){\n ngenes=dim(da)[1]\n # Sample averages\n sampleavg=apply(da,2,mean)\n # Gene averages\n geneavg=apply(da,1,mean)\n totalavg=mean(da)\n #\n # Variances \n genevar0=rep(0,ngenes)\n for (gene in 1:ngenes){\n  genevar0[gene]=\n  sum((dat[gene,]-geneavg[gene]-sampleavg+totalavg)^2)/\n        ((ntotal-1)*(1-2/ngenes))\n  }\n genevar=genevar0-sum(genevar0)/(ngenes*ngenes-ngenes)\n #\n # Change possible negative values\n geneMinvar=rep(0,ngenes)\n z=da\n for (gene in 1:ngenes){\n  varpair=rep(0,ngenes)\n  for (gene1 in 1:ngenes){varpair[gene1]=var(z[gene,]-z[gene1,])}\n  geneMinvar[gene]=min(varpair[-gene])/4\n  }\n # Final variances\n genevar=ifelse(genevar<0,geneMinvar,genevar)\n #\n return(genevar)\n }\n#     End of function MakeStabOne\n#\n#################################################\n#\n# Main part\n#\nif (ngr>1){   # More than one group.\n#\nres=MakeStab(dat)\n#\ngcand=c(1:ngenes)[res[,3]<pStabLim]\nncand=length(gcand)\nif (ncand<4){\n if (ngenes>3){\n  li=sort(res[,3])[4]\n  gcand=c(1:ngenes)[res[,3]<=li]\n  ncand=length(gcand)\n  } else {\n  gcand=c(1:ngenes)\n  ncand=length(gcand)\n  }\n }\n #\n vv2=c()\n #\n for (g1 in 1:(ncand-1)){\n  for (g2 in (g1+1):ncand){\n   qmeas=MakeComb2(gcand[g1],gcand[g2],res)\n   vv2=rbind(vv2,c(gcand[g1],gcand[g2],qmeas))\n }}\n #\n ord=order(res[,3])\n FinalRes=list(Ordered=\n data.frame(\"GroupDif\"=round(res[ord,1],2),\"GroupSD\"=round(res[ord,2],2),\n  \"Stability\"=round(res[ord,3],2),row.names=genenames[ord]),\n UnOrdered=\n data.frame(\"GroupDif\"=round(res[,1],2),\"GroupSD\"=round(res[,2],2),\n \"Stability\"=round(res[,3],2),\n \"IGroupSD\"=round(sqrt(res[,(4+1):(4+ngr)]),2),\n \"IGroupDif\"=round(res[,(4+ngr+1):(4+ngr+ngr)],2),\n row.names=genenames),\n PairOfGenes=\n data.frame(\"Gene1\"=genenames[vv2[,1]],\"Gene2\"=genenames[vv2[,2]],\n \"Stability\"=round(vv2[,3],2)))\n#\nreturn(FinalRes)\n#\n} else {    # End of more than one group: next is for one group only.\n#\n#\nsigma=sqrt(MakeStabOne(dat))\n#\nsiglim=(min(sigma)+0.1)\ngcand=c(1:ngenes)[sigma<siglim]\nncand=length(gcand)\n#\nif ((ncand>=2)&(ngenes>3)){\n #\n vv2=c()\n #\n for (g1 in 1:(ncand-1)){\n  for (g2 in (g1+1):ncand){\n   dat1=rbind(dat[-c(gcand[g1],gcand[g2]),],\n    apply(dat[c(gcand[g1],gcand[g2]),],2,mean))\n   qmeas=sqrt(MakeStabOne(dat1))\n   vv2=rbind(vv2,c(gcand[g1],gcand[g2],qmeas[ngenes-1]))\n }}\n ord=order(sigma)\n FinalRes=list(Ordered=\n data.frame(\"GroupSD\"=round(sigma[ord],2),row.names=genenames[ord]),\n PairOfGenes=\n data.frame(\"Gene1\"=genenames[vv2[,1]],\"Gene2\"=genenames[vv2[,2]],\n \"GroupSD\"=round(vv2[,3],2)))\n } else { # No combined genes to consider\n ord=order(sigma)\n FinalRes=list(Ordered=\n data.frame(\"GroupSD\"=round(sigma[ord],2),row.names=genenames[ord]))\n } # End ncand<2 or ngenes<=3\n#\nreturn(FinalRes)\n#\n}  # End one group only\n#\n} # End of main function\n\n\n\n\n\n\n\n\n\n```\n\n#normfinder, findign the best HKG\n```{r HKG}\nb<-read.csv(\"test.csv\")\nbb<-subset(b,b$CT_18s>1 & b$CT_actin > 1 & b$CT_gapdh > 1)\ndim(bb)\n\nbn<-as.data.frame(t(subset(bb,select=c(\"Site\",\"CT_18s\",\"CT_actin\",\"CT_gapdh\"))))\n#write.csv(bn,\"normfinder_prelim.csv\")\n\n\naph=Normfinder(\"20160211_prelim_normfinder.txt\")\n#single gene stability\naph$Ordered\n#pairs of genes\naph$PairOfGenes\n\n\n```\n\n\n```{r sessioninfo}\nsessionInfo()\n```\n\n\n",
    "created" : 1455201604586.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "12|24|18|3|\n25|22|49|3|\n118|21|160|3|\n162|14|189|3|\n191|59|215|3|\n217|26|467|3|\n470|10|486|3|\n489|18|491|3|\n",
    "hash" : "131857652",
    "id" : "FFBC0619",
    "lastKnownWriteTime" : 1455206862,
    "path" : "~/zscience/Dimensions_project/Data/2013-2014_stressed_ants_in_warmingchambers/20150824_stressed_ants.Rmd",
    "project_path" : "20150824_stressed_ants.Rmd",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_markdown"
}